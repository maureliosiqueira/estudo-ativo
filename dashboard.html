<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estudo Ativo - Dashboard</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>üìö Estudo Ativo</h1>
      <button id="logoutBtn">Sair</button>
    </header>

    <div id="user-info">
      <p>Bem-vindo, <span id="userName">...</span>!</p>
      <p>Plano: <span id="userPlan">Gratuito</span></p>
    </div>

    <!-- Lista de t√≥picos -->
    <div id="topics-list">
      <h2>T√≥picos Dispon√≠veis</h2>
      <ul>
        <li><a href="#" onclick="loadTopic('exemplo')">Exemplo (50 quest√µes)</a></li>
      </ul>
    </div>

    <!-- Exibi√ß√£o de quest√µes -->
    <div id="question-container" style="display:none;">
      <h2 id="topic-title">T√≥pico</h2>
      <div id="question-box"></div>
      <div id="notes-section"></div>
      <button onclick="nextQuestion()">Pr√≥xima Quest√£o</button>
    </div>

    <!-- Status di√°rio -->
    <p class="footer">Limite di√°rio: <span id="daily-status">Carregando...</span></p>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Configura√ß√£o do Firebase -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCZ5Pgzv08pcR6Xfp-SdjdYmqqSw7brNQ4",
      authDomain: "estudo-ativo-projeto.firebaseapp.com",
      projectId: "estudo-ativo-projeto",
      storageBucket: "estudo-ativo-projeto.firebasestorage.app",
      messagingSenderId: "257330913879",
      appId: "1:257330913879:web:4babb1b1fa4a77cd7bb912",
      measurementId: "G-SJT94J9CP7"
    };

    firebase.initializeApp(firebaseConfig);
  </script>

  <!-- Fun√ß√µes de autentica√ß√£o -->
  <script>
    function signOutUser() {
      firebase.auth().signOut().then(() => {
        window.location.href = 'index.html';
      });
    }

    // Verifica autentica√ß√£o ao carregar a p√°gina
    window.addEventListener('load', () => {
      firebase.auth().onAuthStateChanged(user => {
        if (!user) {
          window.location.href = 'index.html'; // Redireciona para login se n√£o estiver logado
        } else {
          document.getElementById('userName').textContent = user.displayName || user.email;
          document.getElementById('userPlan').textContent = 'Gratuito';
        }
      });

      document.getElementById('logoutBtn')?.addEventListener('click', signOutUser);
    });
  </script>

  <!-- Controle de limite di√°rio -->
  <script>
    let dailyCount = 0;
    const DAILY_LIMIT_FREE = 10;

    function updateDailyStatus() {
      const today = new Date().toDateString();
      const storedDate = localStorage.getItem('estudoAtivo.lastDate');
      const storedCount = parseInt(localStorage.getItem('estudoAtivo.dailyCount') || '0');

      if (storedDate !== today) {
        dailyCount = 0;
        localStorage.setItem('estudoAtivo.lastDate', today);
        localStorage.setItem('estudoAtivo.dailyCount', '0');
      } else {
        dailyCount = storedCount;
      }

      document.getElementById('daily-status').textContent = 
        `${dailyCount}/${DAILY_LIMIT_FREE} (gratuito)`;
    }

    function incrementDailyCount() {
      dailyCount++;
      localStorage.setItem('estudoAtivo.dailyCount', dailyCount.toString());
      updateDailyStatus();
    }

    function canAnswerMore() {
      const isPremium = document.getElementById('userPlan')?.textContent === 'Premium';
      return isPremium || dailyCount < DAILY_LIMIT_FREE;
    }

    window.onload = updateDailyStatus;
  </script>

  <!-- L√≥gica de exibi√ß√£o de quest√µes -->
  <script>
    let currentTopic = null;
    let currentQuestionIndex = 0;

    async function loadTopic(topicKey) {
      try {
        const response = await fetch(`topicos/${topicKey}.json`);
        if (!response.ok) throw new Error('T√≥pico n√£o encontrado');
        currentTopic = await response.json();
        currentQuestionIndex = 0;
        showQuestion();
        document.getElementById('topics-list').style.display = 'none';
        document.getElementById('question-container').style.display = 'block';
        document.getElementById('topic-title').textContent = currentTopic.titulo;
      } catch (error) {
        alert('Erro ao carregar o t√≥pico: ' + error.message);
      }
    }

    function showQuestion() {
      if (!canAnswerMore()) {
        document.getElementById('question-box').innerHTML = `
          <p>‚ö†Ô∏è Limite di√°rio atingido! Volte amanh√£ ou <a href="#">torne-se premium</a>.</p>
        `;
        return;
      }

      const q = currentTopic.questoes[currentQuestionIndex];
      document.getElementById('question-box').innerHTML = `
        <p><strong>Quest√£o ${q.id} de ${currentTopic.questoes.length}</strong></p>
        <p>${q.enunciado}</p>
        <ul>
          ${q.alternativas.map(alt => `<li><label><input type="radio" name="q" value="${alt[0]}"> ${alt}</label></li>`).join('')}
        </ul>
        <button onclick="showAnswer(${q.id})">Ver Resposta</button>
      `;
      loadNote(q.id);
    }

    function showAnswer(questionId) {
      const q = currentTopic.questoes[currentQuestionIndex];
      document.getElementById('question-box').innerHTML += `
        <div class="answer">
          <p><strong>Resposta correta:</strong> ${q.resposta_correta}</p>
          <p><em>${q.explicacao}</em></p>
        </div>
      `;
      incrementDailyCount();
    }

    function nextQuestion() {
      currentQuestionIndex++;
      if (currentQuestionIndex < currentTopic questoes.length) {
        showQuestion();
      } else {
        alert('Fim do t√≥pico!');
        location.reload();
      }
    }
  </script>

  <!-- Sistema de anota√ß√µes -->
  <script>
    let currentNoteQuestionId = null;

    function loadNote(questionId) {
      currentNoteQuestionId = questionId;
      const key = `note_${questionId}`;
      const note = localStorage.getItem(key) || '';
      
      document.getElementById('notes-section').innerHTML = `
        <h3>O que eu aprendi?</h3>
        <textarea id="noteInput" rows="3" placeholder="Escreva suas anota√ß√µes aqui...">${note}</textarea>
        <button onclick="saveNote()">Salvar Anota√ß√£o</button>
      `;
    }

    function saveNote() {
      const note = document.getElementById('noteInput').value;
      const key = `note_${currentNoteQuestionId}`;
      localStorage.setItem(key, note);
      alert('Anota√ß√£o salva!');
    }
  </script>
</body>
</html>
